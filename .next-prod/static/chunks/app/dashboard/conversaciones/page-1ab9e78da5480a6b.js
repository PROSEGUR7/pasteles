(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[402],{65932:(e,t,a)=>{Promise.resolve().then(a.bind(a,71449))},71449:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c});var s=a(95155),r=a(12115);let n=["Todos","WhatsApp","Instagram","Web"];function c(){let[e,t]=(0,r.useState)([]),[a,c]=(0,r.useState)([]),[l,i]=(0,r.useState)(""),[o,d]=(0,r.useState)("Todos"),[x,u]=(0,r.useState)(null),[m,f]=(0,r.useState)(!0),[h,p]=(0,r.useState)(!1),[b,v]=(0,r.useState)(null),[g,j]=(0,r.useState)(!1),[N,y]=(0,r.useState)(null),[w,C]=(0,r.useState)(!1),[S,E]=(0,r.useState)(""),k=(0,r.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{e||f(!0);let a="Todos"!==o?"?canal=".concat(encodeURIComponent(o)):"",s=await fetch("/api/conversaciones".concat(a),{cache:"no-store"});if(!s.ok)throw Error("Error cargando conversaciones");let r=await s.json();t(r.conversations||[]),v(null)}catch(e){console.error("[Conversaciones] Fetch error",e),v("No pudimos cargar las conversaciones")}finally{e||f(!1)}},[o]),I=(0,r.useCallback)(async e=>{try{p(!0);let t=encodeURIComponent(e),a=await fetch("/api/conversaciones/".concat(t),{cache:"no-store"});if(!a.ok)throw Error("Error cargando mensajes");let s=await a.json();c(s.messages||[]),await fetch("/api/conversaciones/".concat(t),{method:"PATCH"}),k(!0)}catch(e){console.error("[Conversaciones] Mensajes error",e)}finally{p(!1)}},[k]),T=(0,r.useCallback)(e=>{u(e),I(e)},[I]),A=e.find(e=>e.waId===x)||null,D=(null==A?void 0:A.botStatus)==="activo",M=!A||"cerrado"===A.estado||D,L=(0,r.useCallback)(async()=>{if(x&&!g)try{y(null),j(!0);let e=encodeURIComponent(x),a=await fetch("/api/conversaciones/".concat(e),{method:"DELETE"});if(!a.ok){let e="Error cerrando la conversaci\xf3n";try{let t=await a.json();"string"==typeof(null==t?void 0:t.error)&&(e=t.error)}catch(e){}throw Error(e)}t(e=>e.map(e=>e.waId===x?{...e,estado:"cerrado"}:e)),c([]),u(null),E(""),k(!0)}catch(e){console.error("[Conversaciones] Cerrar chat",e),y(e instanceof Error&&e.message?e.message:"No pudimos cerrar el chat. Intenta nuevamente.")}finally{j(!1)}},[x,g,k]),_=(0,r.useCallback)(async()=>{if(A&&!w)try{y(null),C(!0);let e=encodeURIComponent(A.waId),a="activo"===A.botStatus?"inactivo":"activo",s=await fetch("/api/conversaciones/".concat(e),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({botStatus:a})});if(!s.ok){let e="No se pudo actualizar el estado del bot";try{let t=await s.json();"string"==typeof(null==t?void 0:t.error)&&(e=t.error)}catch(e){}throw Error(e)}t(e=>e.map(e=>e.waId===A.waId?{...e,botStatus:a}:e))}catch(e){console.error("[Conversaciones] Toggle bot",e),y(e instanceof Error&&e.message?e.message:"No pudimos actualizar el estado del bot.")}finally{C(!1)}},[A,w]);(0,r.useEffect)(()=>{k();let e=setInterval(()=>k(!0),5e3);return()=>clearInterval(e)},[k]),(0,r.useEffect)(()=>{if(!e.length){u(null),c([]);return}x&&e.some(e=>e.waId===x)||(u(null),c([]))},[e,x]),(0,r.useEffect)(()=>{y(null),j(!1)},[x]);let B=(0,r.useMemo)(()=>{let t=l.trim().toLowerCase();return t?e.filter(e=>{var a,s;return e.nombre.toLowerCase().includes(t)||null!=(s=null==(a=e.lastMessage)?void 0:a.toLowerCase().includes(t))&&s}):e},[l,e]);return(0,s.jsxs)("div",{className:"h-full flex flex-col gap-4 overflow-y-auto overflow-x-hidden min-h-0 pr-1",children:[(0,s.jsxs)("div",{className:"animate-in",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold text-surface-50",children:"Conversaciones"}),(0,s.jsx)("p",{className:"text-surface-400 text-sm mt-1",children:"Recibe y responde mensajes de Meta en tiempo real."})]}),(0,s.jsx)("div",{className:"glass-card overflow-hidden animate-in flex-1 min-h-0",style:{animationDelay:"100ms"},children:(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-[360px_1fr] h-full",children:[(0,s.jsxs)("aside",{className:"border-r border-surface-800/30 bg-white/50 flex flex-col min-h-0",children:[(0,s.jsxs)("div",{className:"p-4 border-b border-surface-800/20 space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-[0.2em] text-surface-500",children:"Chats"}),(0,s.jsx)("h2",{className:"text-lg font-semibold text-surface-100",children:m?"Cargando...":"".concat(B.length," activos")})]}),(0,s.jsx)("span",{className:"text-[11px] text-surface-400",children:"Actualiza cada 5s"})]}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"absolute left-3 top-1/2 -translate-y-1/2 text-surface-400",children:[(0,s.jsx)("circle",{cx:"11",cy:"11",r:"8"}),(0,s.jsx)("path",{d:"m21 21-4.3-4.3"})]}),(0,s.jsx)("input",{value:l,onChange:e=>i(e.target.value),className:"input-field pl-9 text-sm",placeholder:"Buscar por nombre o mensaje"})]}),(0,s.jsx)("div",{className:"flex gap-2 overflow-x-auto text-xs",children:n.map(e=>(0,s.jsx)("button",{onClick:()=>d(e),className:"px-3 py-1.5 rounded-full border text-[11px] ".concat(o===e?"bg-primary-500 text-white border-primary-500":"border-surface-800/30 text-surface-400"),children:e},e))})]}),b&&(0,s.jsx)("div",{className:"px-4 py-3 text-xs text-primary-600 bg-primary-500/10 border border-primary-500/30",children:b}),(0,s.jsxs)("div",{className:"divide-y divide-surface-800/15 flex-1 overflow-y-auto min-h-0",children:[B.map(e=>{let t=x===e.waId;return(0,s.jsx)("button",{onClick:()=>T(e.waId),className:"w-full text-left px-4 py-3 transition ".concat(t?"bg-primary-500/10":"hover:bg-primary-500/5"),children:(0,s.jsxs)("div",{className:"flex items-start gap-3",children:[(0,s.jsx)("div",{className:"w-9 h-9 rounded-full bg-surface-900 text-surface-50 text-xs font-bold flex items-center justify-center uppercase",children:e.nombre.split(" ").filter(Boolean).slice(0,2).map(e=>e[0]).join("")}),(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,s.jsx)("p",{className:"text-sm font-semibold text-surface-100 truncate",children:e.nombre}),(0,s.jsx)("span",{className:"text-[10px] text-surface-500 shrink-0",children:function(e){if(!e)return"";let t=new Date(e);if(Number.isNaN(t.getTime()))return"";let a=new Date,s=a.getTime()-t.getTime();return s<864e5&&t.getDate()===a.getDate()?t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}):s<1728e5?"ayer":t.toLocaleDateString("es-ES",{day:"2-digit",month:"short"})}(e.lastMessageAt)})]}),(0,s.jsx)("p",{className:"text-xs text-surface-400 truncate",children:e.lastMessage||"Sin mensajes"}),(0,s.jsxs)("div",{className:"mt-2 flex items-center gap-2 text-[10px] text-surface-500",children:[(0,s.jsxs)("span",{className:"inline-flex items-center gap-1",children:[(0,s.jsx)("span",{className:"h-2 w-2 rounded-full ".concat("cerrado"===e.estado?"bg-surface-400":"bg-emerald-500")}),e.canal]}),"cerrado"===e.estado&&(0,s.jsx)("span",{className:"px-2 py-0.5 rounded-full bg-surface-900/10 text-surface-500",children:"Cerrado"})]})]}),e.unreadCount>0&&(0,s.jsx)("span",{className:"shrink-0 w-5 h-5 rounded-full bg-primary-500 text-white text-[10px] font-semibold flex items-center justify-center",children:e.unreadCount})]})},e.waId)}),!m&&0===B.length&&(0,s.jsx)("div",{className:"p-6 text-center text-surface-500 text-sm",children:"A\xfan no hay conversaciones."})]})]}),(0,s.jsx)("section",{className:"relative bg-white/30 flex flex-col min-h-0 overflow-hidden",children:A?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"px-6 py-4 border-b border-surface-800/20 bg-white/70 space-y-4",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-sm font-semibold text-surface-100",children:A.nombre}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-3 text-xs text-surface-400 mt-1",children:[(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"h-2 w-2 rounded-full ".concat("cerrado"===A.estado?"bg-surface-400":"bg-emerald-500")}),"cerrado"===A.estado?"Conversaci\xf3n cerrada":"Conversaci\xf3n activa"]}),(0,s.jsx)("span",{className:"px-2 py-0.5 rounded-full bg-surface-900 text-surface-200",children:A.canal})]})]}),(0,s.jsxs)("div",{className:"flex gap-2 text-xs",children:[(0,s.jsx)("button",{className:"px-3 py-2 border border-surface-800/30 rounded-md text-surface-400",children:"Programar"}),(0,s.jsx)("button",{className:"px-3 py-2 border border-surface-800/30 rounded-md text-surface-400",children:"Etiquetar"}),(0,s.jsx)("button",{onClick:L,disabled:g||"cerrado"===A.estado,className:"px-3 py-2 rounded-md text-white ".concat(g||"cerrado"===A.estado?"bg-primary-500/60 cursor-not-allowed":"bg-primary-500 hover:bg-primary-600"),children:"cerrado"===A.estado?"Chat cerrado":g?"Cerrando...":"Cerrar chat"})]})]}),(0,s.jsx)("div",{className:"flex flex-wrap gap-3 text-xs",children:(0,s.jsxs)("div",{className:"flex items-center justify-between gap-4 rounded-2xl border border-surface-800/20 bg-white px-3 py-2 min-w-[220px]",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-[10px] uppercase tracking-[0.2em] text-surface-500",children:"Bot IA"}),(0,s.jsx)("p",{className:"text-sm font-semibold text-surface-100",children:D?"En espera":"Desactivado"})]}),(0,s.jsx)("button",{type:"button",onClick:_,disabled:w,className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors ".concat(D?"bg-emerald-500":"bg-surface-700"," ").concat(w?"opacity-60 cursor-not-allowed":"cursor-pointer"),"aria-label":"Activar o desactivar bot",children:(0,s.jsx)("span",{className:"inline-block h-5 w-5 transform rounded-full bg-white transition-transform ".concat(D?"translate-x-5":"translate-x-1")})})]})}),N&&(0,s.jsx)("div",{className:"text-[11px] text-primary-600 bg-primary-500/10 border border-primary-500/30 rounded-md px-3 py-2",children:N})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-y-auto px-6 py-5 space-y-4 bg-white/20 min-h-0",children:[h&&(0,s.jsx)("div",{className:"text-center text-xs text-surface-400",children:"Cargando mensajes..."}),a.map(e=>{var t,a;return(0,s.jsx)("div",{className:"flex ".concat("outbound"===e.direction?"justify-end":"justify-start"),children:(0,s.jsxs)("div",{className:"max-w-[75%] rounded-2xl px-4 py-3 text-sm shadow-sm ".concat("outbound"===e.direction?"bg-primary-500 text-white":"bg-white border border-surface-800/15 text-surface-100"),children:[(0,s.jsxs)("div",{className:"mb-1.5 flex items-center gap-2",children:[(0,s.jsx)("span",{className:"inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold ".concat("outbound"===e.direction?"bg-white/20 text-white":"ia"===(t=e.senderType)?"bg-emerald-500/15 text-emerald-700":"humano"===t?"bg-blue-500/15 text-blue-700":"cliente"===t?"bg-surface-900/10 text-surface-500":"bg-violet-500/15 text-violet-700"),children:"ia"===(a=e.senderType)?"IA":"humano"===a?"Humano":"cliente"===a?"Cliente":"Sistema"}),e.interventionStatus&&(0,s.jsx)("span",{className:"inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold ".concat("activo"===e.interventionStatus?"bg-emerald-500/15 text-emerald-700":"bg-surface-900/10 text-surface-500"),children:"activo"===e.interventionStatus?"Activo":"Inactivo"})]}),(0,s.jsx)("p",{children:e.body||"Mensaje sin texto"}),(0,s.jsxs)("p",{className:"mt-1 text-[10px] ".concat("outbound"===e.direction?"text-white/70":"text-surface-400"),children:[function(e){if(!e)return"";let t=new Date(e);return Number.isNaN(t.getTime())?"":t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}(e.timestamp)," \xb7 ",e.source.toUpperCase()]})]})},e.messageId)}),!h&&0===a.length&&(0,s.jsx)("div",{className:"text-center text-surface-400 text-sm py-12",children:"A\xfan no hay mensajes registrados para este contacto."})]}),(0,s.jsxs)("div",{className:"border-t border-surface-800/20 bg-white/70 p-4",children:[(0,s.jsxs)("div",{className:"flex gap-3",children:[(0,s.jsx)("input",{value:S,onChange:e=>E(e.target.value),className:"flex-1 input-field ".concat(M?"bg-surface-100 text-surface-500":"bg-white"),placeholder:"Escribe un mensaje para ".concat(A.nombre),disabled:M}),(0,s.jsx)("button",{className:"btn-primary whitespace-nowrap",disabled:M,children:"Enviar"})]}),(0,s.jsx)("p",{className:"text-[11px] text-surface-400 mt-2",children:"cerrado"===A.estado?"Este chat est\xe1 cerrado.":D?"Bot IA activo: desact\xedvalo para responder manualmente.":"Modo manual activo: ya puedes escribir."})]})]}):(0,s.jsx)("div",{className:"h-full flex items-center justify-center p-8",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"w-20 h-20 rounded-2xl bg-surface-800/60 flex items-center justify-center mx-auto mb-4",children:(0,s.jsx)("svg",{width:"34",height:"34",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.7",className:"text-surface-500",children:(0,s.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})}),(0,s.jsx)("h3",{className:"text-xl font-semibold text-surface-100",children:"Selecciona una conversaci\xf3n"}),(0,s.jsx)("p",{className:"text-sm text-surface-500 mt-2",children:"Elige un contacto del panel izquierdo para ver su chat."})]})})})]})})]})}}},e=>{e.O(0,[441,255,358],()=>e(e.s=65932)),_N_E=e.O()}]);